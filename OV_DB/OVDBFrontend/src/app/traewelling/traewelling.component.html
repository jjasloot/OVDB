<div class="traewelling-container">
  @if (loading) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <span>{{ 'TRAEWELLING.LOADING_TRIPS' | translate }}</span>
  </div>
  } @else if (!connectionStatus?.connected) {
  <div class="not-connected">
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ 'TRAEWELLING.TITLE' | translate }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="not-connected-content">
          <mat-icon>link_off</mat-icon>
          <p>{{ 'PROFILE.TRAEWELLING_NOT_CONNECTED' | translate }}</p>
          <button mat-raised-button color="primary" (click)="router.navigate(['/profile'])">
            <mat-icon>arrow_back</mat-icon>
            {{ 'BACK' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  } @else {
  <h1>{{ 'TRAEWELLING.TITLE' | translate }}</h1>

  <!-- Statistics Card -->
  @if (stats) {
  <mat-card class="stats-card">
    <mat-card-header>
      <mat-card-title>{{ 'TRAEWELLING.STATS' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">{{ stats.totalTrips }}</div>
          <div class="stat-label">{{ 'TRAEWELLING.TOTAL_TRIPS' | translate }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ stats.importedTrips }}</div>
          <div class="stat-label">{{ 'TRAEWELLING.IMPORTED_TRIPS' | translate }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ stats.unimportedTrips }}</div>
          <div class="stat-label">{{ 'TRAEWELLING.UNIMPORTED_COUNT' | translate }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ stats.enhancedInstances }}</div>
          <div class="stat-label">{{ 'TRAEWELLING.ENHANCED_INSTANCES' | translate }}</div>
        </div>
      </div>
      @if (stats.connectedSince) {
      <div class="connected-since">
        {{ 'TRAEWELLING.CONNECTED_SINCE' | translate }}:
        {{ stats.connectedSince | date:'medium' }}
      </div>
      }
    </mat-card-content>
  </mat-card>
  }

  <!-- Actions Card -->
  <mat-card class="actions-card">
    <mat-card-content>
      <div class="actions-row">
        <button mat-raised-button color="primary" (click)="refreshTrips()" [disabled]="tripsLoading">
          <mat-icon>refresh</mat-icon>
          {{ 'TRAEWELLING.REFRESH' | translate }}
        </button>

      </div>
    </mat-card-content>
  </mat-card>

  <!-- Trips List Card -->
  <mat-card class="trips-card">
    <mat-card-header>
      <mat-card-title>{{ 'TRAEWELLING.UNIMPORTED_TRIPS' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (tripsLoading) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <span>{{ 'TRAEWELLING.LOADING_TRIPS' | translate }}</span>
      </div>
      } @else if (unimportedTrips.length === 0) {
      <div class="no-trips">
        <mat-icon>check_circle</mat-icon>
        <p>{{ 'TRAEWELLING.NO_TRIPS' | translate }}</p>
      </div>
      } @else {
      <div class="trips-list">
        @for (trip of unimportedTrips; track trip.id) {
        <mat-card class="trip-card">
          <mat-card-header>
            <mat-card-title>
              {{ trip.train?.lineName }} {{ trip.train?.number }}
            </mat-card-title>
            <mat-card-subtitle>
              {{ trip.train?.origin?.name }} → {{ trip.train?.destination?.name }}
            </mat-card-subtitle>
          </mat-card-header>
          
          <mat-card-content>
            <!-- Trip Timing Details -->
            <div class="timing-section">
              <h4>{{ 'TRAEWELLING.DEPARTURE_PLANNED' | translate }}</h4>
              <div class="time-details">
                @if (trip.train?.origin?.departurePlanned) {
                <mat-chip-set>
                  <mat-chip>
                    <mat-icon>schedule</mat-icon>
                    {{ formatTime(trip.train.origin.departurePlanned) }}
                  </mat-chip>
                  @if (trip.train?.origin?.departurePlatformPlanned) {
                  <mat-chip>
                    <mat-icon>place</mat-icon>
                    {{ 'TRAEWELLING.PLATFORM' | translate }}: {{ trip.train.origin.departurePlatformPlanned }}
                  </mat-chip>
                  }
                </mat-chip-set>
                }
                
                @if (trip.train?.origin?.departureReal) {
                <h4>{{ 'TRAEWELLING.DEPARTURE_ACTUAL' | translate }}</h4>
                <mat-chip-set>
                  <mat-chip [color]="isDelayed(trip.train.origin.departurePlanned, trip.train.origin.departureReal) ? 'warn' : 'primary'">
                    <mat-icon>{{ isDelayed(trip.train.origin.departurePlanned, trip.train.origin.departureReal) ? 'warning' : 'check' }}</mat-icon>
                    {{ formatTime(trip.train.origin.departureReal) }}
                    @if (isDelayed(trip.train.origin.departurePlanned, trip.train.origin.departureReal)) {
                    <span>({{ 'TRAEWELLING.DELAYED' | translate }})</span>
                    } @else {
                    <span>({{ 'TRAEWELLING.ON_TIME' | translate }})</span>
                    }
                  </mat-chip>
                  @if (trip.train?.origin?.departurePlatformReal) {
                  <mat-chip>
                    <mat-icon>place</mat-icon>
                    {{ 'TRAEWELLING.PLATFORM' | translate }}: {{ trip.train.origin.departurePlatformReal }}
                  </mat-chip>
                  }
                </mat-chip-set>
                }
              </div>
            </div>

            @if (trip.train?.destination?.arrivalPlanned || trip.train?.destination?.arrivalReal) {
            <div class="timing-section">
              @if (trip.train?.destination?.arrivalPlanned) {
              <h4>{{ 'TRAEWELLING.ARRIVAL_PLANNED' | translate }}</h4>
              <mat-chip-set>
                <mat-chip>
                  <mat-icon>schedule</mat-icon>
                  {{ formatTime(trip.train.destination.arrivalPlanned) }}
                </mat-chip>
                @if (trip.train?.destination?.arrivalPlatformPlanned) {
                <mat-chip>
                  <mat-icon>place</mat-icon>
                  {{ 'TRAEWELLING.PLATFORM' | translate }}: {{ trip.train.destination.arrivalPlatformPlanned }}
                </mat-chip>
                }
              </mat-chip-set>
              }

              @if (trip.train?.destination?.arrivalReal) {
              <h4>{{ 'TRAEWELLING.ARRIVAL_ACTUAL' | translate }}</h4>
              <mat-chip-set>
                <mat-chip [color]="isDelayed(trip.train.destination.arrivalPlanned, trip.train.destination.arrivalReal) ? 'warn' : 'primary'">
                  <mat-icon>{{ isDelayed(trip.train.destination.arrivalPlanned, trip.train.destination.arrivalReal) ? 'warning' : 'check' }}</mat-icon>
                  {{ formatTime(trip.train.destination.arrivalReal) }}
                  @if (isDelayed(trip.train.destination.arrivalPlanned, trip.train.destination.arrivalReal)) {
                  <span>({{ 'TRAEWELLING.DELAYED' | translate }})</span>
                  } @else {
                  <span>({{ 'TRAEWELLING.ON_TIME' | translate }})</span>
                  }
                </mat-chip>
                @if (trip.train?.destination?.arrivalPlatformReal) {
                <mat-chip>
                  <mat-icon>place</mat-icon>
                  {{ 'TRAEWELLING.PLATFORM' | translate }}: {{ trip.train.destination.arrivalPlatformReal }}
                </mat-chip>
                }
              </mat-chip-set>
              }
            </div>
            }

            <!-- Trip Details -->
            <mat-chip-set class="trip-details">
              @if (trip.train?.duration) {
              <mat-chip>
                <mat-icon>schedule</mat-icon>
                {{ formatDuration(trip.train?.duration) }}
              </mat-chip>
              }
              @if (trip.train?.distance) {
              <mat-chip>
                <mat-icon>straighten</mat-icon>
                {{ formatDistance(trip.train?.distance) }}
              </mat-chip>
              }
              @if (trip.train?.category) {
              <mat-chip>
                <mat-icon>directions_transit</mat-icon>
                {{ getCategoryName(trip.train?.category) | translate }}
              </mat-chip>
              }
              @if (trip.createdAt) {
              <mat-chip>
                <mat-icon>event</mat-icon>
                {{ trip.createdAt | date:'medium' }}
              </mat-chip>
              }
            </mat-chip-set>

            @if (trip.body) {
            <div class="trip-description">
              <mat-icon>description</mat-icon>
              <span>{{ trip.body }}</span>
            </div>
            }
          </mat-card-content>

          <mat-card-actions>
            <button mat-raised-button color="warn" (click)="ignoreTrip(trip)">
              <mat-icon>visibility_off</mat-icon>
              {{ 'TRAEWELLING.IGNORE_TRIP' | translate }}
            </button>

            <button mat-raised-button color="primary" (click)="searchExistingRoutes(trip)">
              <mat-icon>search</mat-icon>
              {{ 'TRAEWELLING.SEARCH_ROUTE_INSTANCES' | translate }}
            </button>
          </mat-card-actions>

          <!-- RouteInstance Search Results -->
          @if (searchTrip?.id === trip.id && searchingRouteInstances) {
          <mat-card-content>
            <div class="route-search-loading">
              <mat-progress-spinner diameter="20"></mat-progress-spinner>
              <span>{{ 'TRAEWELLING.SEARCHING_ROUTE_INSTANCES' | translate }}</span>
            </div>
          </mat-card-content>
          }

          @if (searchTrip?.id === trip.id && existingRouteInstances.length > 0) {
          <mat-card-content>
            <h4>{{ 'TRAEWELLING.SELECT_ROUTE_INSTANCE' | translate }}</h4>
            <div class="routes-list">
              @for (routeInstance of existingRouteInstances; track routeInstance.id) {
              <mat-card class="route-option" [class.already-linked]="routeInstance.hasTraewellingLink">
                <mat-card-content>
                  <div class="route-info">
                    <strong>{{ routeInstance.routeName || (routeInstance.from + ' - ' + routeInstance.to) }}</strong>
                    <div class="route-description">
                      {{ routeInstance.from }} → {{ routeInstance.to }}
                    </div>
                    <mat-chip-set class="route-details">
                      @if (routeInstance.startTime) {
                      <mat-chip>
                        <mat-icon>schedule</mat-icon>
                        {{ routeInstance.startTime | date:'short' }}
                      </mat-chip>
                      }
                      @if (routeInstance.endTime) {
                      <mat-chip>
                        <mat-icon>schedule</mat-icon>
                        {{ routeInstance.endTime | date:'short' }}
                      </mat-chip>
                      }
                      @if (routeInstance.durationHours) {
                      <mat-chip>
                        <mat-icon>timer</mat-icon>
                        {{ formatDuration(routeInstance.durationHours * 60) }}
                      </mat-chip>
                      }
                      @if (routeInstance.hasTraewellingLink) {
                      <mat-chip color="accent">
                        <mat-icon>link</mat-icon>
                        {{ 'TRAEWELLING.ALREADY_LINKED' | translate }}
                      </mat-chip>
                      }
                    </mat-chip-set>
                  </div>
                </mat-card-content>
                <mat-card-actions>
                  <button mat-raised-button color="primary" (click)="linkToExistingRouteInstance(trip, routeInstance)"
                    [disabled]="routeInstance.hasTraewellingLink">
                    <mat-icon>link</mat-icon>
                    @if (routeInstance.hasTraewellingLink) {
                    {{ 'TRAEWELLING.ALREADY_LINKED' | translate }}
                    } @else {
                    {{ 'TRAEWELLING.LINK_TO_EXISTING' | translate }}
                    }
                  </button>
                </mat-card-actions>
              </mat-card>
              }
            </div>
          </mat-card-content>
          } @else if (searchTrip?.id === trip.id && existingRouteInstances.length === 0 && !searchingRouteInstances) {
          <mat-card-content>
            <div class="no-routes-found">
              <mat-icon>search_off</mat-icon>
              <span>{{ 'TRAEWELLING.NO_ROUTE_INSTANCES_FOUND' | translate }}</span>
            </div>
          </mat-card-content>
          }
        </mat-card>
        }
      </div>

      <!-- Pagination -->
      @if (totalPages > 1) {
      <div class="pagination-container">
        <mat-paginator [length]="totalTrips" [pageSize]="tripsPerPage" [pageIndex]="currentPage - 1"
          [pageSizeOptions]="[15, 30, 50]" [showFirstLastButtons]="true" (page)="onPageChange($event)">
        </mat-paginator>
      </div>
      }
      }
    </mat-card-content>
  </mat-card>
  }
</div>